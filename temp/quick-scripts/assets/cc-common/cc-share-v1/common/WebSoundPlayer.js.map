{"version":3,"sources":["WebSoundPlayer.js"],"names":["SoundStateEnum","NONE","PLAYING","SoundStorageKeys","ENABLE_BGM","ENABLE_SFX","WebSoundPlayer","cc","Class","extends","require","properties","gameNode","type","Node","default","keepAudioSession","isUseNativeSound","ctor","webSound","musicInstance","isWebSoundEnable","sys","isBrowser","Howl","soundLoadCount","totalSound","isAllWebSoundLoaded","loadSoundCompleteHdl","onWebSoundLoadComplete","bind","ccMusic","musicOffset","musicVolume","effectVolume","isGameActive","howlMap","bgMusicId","playingSounds","bgMusicUUID","releaseCocosSound","_timer","_sfxCacheGesture","_resumeWithGesture","resumeWithGesture","onLoad","session","window","uuid","instance","currentBGM","_super","MUSIC_VOLUME","SOUND_EFFECT_VOLUME","loadWebSounds","node","Howler","_hasAudioContext","ctx","state","width","height","on","EventType","TOUCH_END","handImage","document","getElementById","addEventListener","game","EVENT_SHOW","onGameShow","EVENT_HIDE","onGameHide","update","dt","_waitingGestureSound","index","length","startTime","duration","loop","endTime","splice","_onOrientationChange","divGestureSound","style","display","forEach","soundObject","sound","volume","offset","play","seek","removeEventListener","off","sounds","soundMap","soundUuids","loadedSoundMap","i","loader","_cache","clip","_owner","AudioClip","_nativeAsset","_uuid","name","url","push","src","release","log","howl","preload","once","waitForGesture","startPlayWithUserGesture","e","fail","k","audioEngine","stopAllEffects","stopMusic","isEnableBGM","playMusic","bgmMain","playHowl","options","id","resumeContext","then","pausedOnHide","resumeMusic","resume","Promise","resolve","playing","pauseMusic","pause","stop","runAction","sequence","delayTime","callFunc","isLoadAllSoundWeb","setMusicVolume","setEffectsVolume","audio","_playMusic","toString","setCurrentTime","_stopMusic","_pauseMusic","os","OS_IOS","_resumeMusic","fadeMusicTo","time","endVolume","value","tweenFade","tween","to","progress","start","end","current","ratio","currentVolume","Math","round","fadeEffectTo","soundId","undefined","getVolume","setVolume","stopEffect","_stopEffect","_stopAllEffects","getState","AudioState","pauseEffect","_pauseEffect","resumeEffect","_resumeEffect","playSFXClick","sfxClick","isEnableSFX","playEffect","_filterPlayingSounds","sfx","_playEffect","_duration","filter","PAUSED","playSFX","playSound","_playSound","stopSound","_stopSound","stopAllAudio","_stopAllAudio","stopAll","sfxToggle","setEffectEnable","enable","gSlotDataStore","isWebSoundClient2","localStorage","setItem","storageKeySFX","bgmToggle","setBgmEnable","storageKeyBGM","enableMusicFunc","clearTimeout","setTimeout","playMainBGM","getPlayState","getMusicState","getDuration","onDestroy","unload","module","exports"],"mappings":"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","file":"WebSoundPlayer.js","sourceRoot":"../../../../../../assets/cc-common/cc-share-v1/common","sourcesContent":["/* global Howl */\n\nconst SoundStateEnum = {\n    NONE: 0,\n    PLAYING: 1\n};\n\nconst SoundStorageKeys = {\n    ENABLE_BGM: \"enableBackgroundMusic\",\n    ENABLE_SFX: \"enableSound\",\n};\n\nconst WebSoundPlayer = cc.Class({\n    extends: require('SoundPlayer'),\n    properties: {\n        gameNode: {\n            type: cc.Node,\n            default: null,\n        },\n\n        keepAudioSession: true,\n        isUseNativeSound: false,\n    },\n\n    ctor()\n    {\n        this.webSound = false;\n        this.musicInstance = null;\n\n        // for fixing safari on ios 13, only for iframe only\n        this.isWebSoundEnable = cc.sys.isBrowser && typeof Howl !== 'undefined';\n\n        this.soundLoadCount = 0;\n        this.totalSound = 0;\n        this.isAllWebSoundLoaded = false;\n        this.loadSoundCompleteHdl = this.onWebSoundLoadComplete.bind(this);\n        this.ccMusic = -1;\n        this.musicOffset = 0;\n        this.musicVolume = 1;\n        this.effectVolume = 1;\n        this.isGameActive = true;\n        this.howlMap = {};\n        this.bgMusicId = -1;\n        this.playingSounds = [];\n        this.bgMusicUUID = 0;\n        this.releaseCocosSound = true;\n        this._timer = 0;\n        this._sfxCacheGesture = [];\n        this._resumeWithGesture = this.resumeWithGesture.bind(this);\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n    onLoad()\n    {\n        if( this.isUseNativeSound ){\n            this.isWebSoundEnable = false;\n        }\n        \n        if (this.isWebSoundEnable)\n        {\n            let session = window['_v_audio_backgroud_session'];\n            if (session)\n            {\n                this.bgMusicUUID = session.uuid;\n                this.bgMusicId = session.bgMusicId;\n                this.musicInstance = session.instance;\n                this.howlMap[session.uuid] = session.instance;\n            }\n        }\n\n        this.currentBGM = null;\n        this._super();\n        this.musicVolume = this.MUSIC_VOLUME;\n        this.effectVolume = this.SOUND_EFFECT_VOLUME;\n        // init config\n        if (this.isWebSoundEnable)\n        {\n            this.webSound = true;\n            this.loadWebSounds(this.gameNode || this.node, null);\n            const Howler = window.Howler;\n            this._hasAudioContext = !!(Howler && Howler.ctx && Howler.ctx.state == \"running\");\n            if (!this._hasAudioContext) {\n                this.node.width = 2024;\n                this.node.height = 2000;\n                this.node.on(cc.Node.EventType.TOUCH_END, this._resumeWithGesture, this, true);\n\n                // this._onOrientationChange();\n                // window.addEventListener('orientationchange', this._onOrientationChange);\n\n                const handImage = document.getElementById('mask');\n                if (handImage) handImage.addEventListener(\"touchstart\", this._resumeWithGesture);\n            }\n        }\n        cc.game.on(cc.game.EVENT_SHOW, this.onGameShow, this);\n        cc.game.on(cc.game.EVENT_HIDE, this.onGameHide, this);\n    },\n\n    update(dt) {\n        if (this._hasAudioContext || !this.isGameActive || !this.webSound) return;\n        this._timer += dt;\n        this._waitingGestureSound();\n    },\n    _waitingGestureSound() {\n        for (let index = this._sfxCacheGesture.length - 1; index >= 0; index--) {\n            const { startTime, duration, loop } = this._sfxCacheGesture[index];\n            const endTime = startTime + duration;\n            if (!loop && this._timer > endTime) {\n                this._sfxCacheGesture.splice(index, 1);\n            }\n        }\n    },          \n    _onOrientationChange() {\n        if (this._hasAudioContext) return;\n        const handImage = document.getElementById('mask');\n        const divGestureSound = document.getElementById('div_gesture_sound');\n        if (!divGestureSound) return;\n        if (!handImage || handImage.style.display == 'none') {\n            divGestureSound.style.display = 'block';\n        } else {\n            divGestureSound.style.display = 'none';\n        }\n    },\n    resumeWithGesture() {\n        if (this._hasAudioContext) return;\n        this._hasAudioContext = true;\n        this._sfxCacheGesture.forEach(soundObject => {\n            const { startTime, duration, loop, sound, volume } = soundObject;\n            const offset = (this._timer - startTime) % duration;\n            const endTime = startTime + duration;\n            if (!loop && this._timer > endTime) return;\n            sound.loop(loop);\n            sound.volume(volume);\n            sound.play();\n            sound.seek(offset);\n        });\n        this._sfxCacheGesture = [];\n\n        const divGestureSound = document.getElementById('div_gesture_sound');\n        if (divGestureSound) divGestureSound.style.display = 'none';\n\n        const handImage = document.getElementById('mask');\n        if (handImage) handImage.removeEventListener('touchstart', this._resumeWithGesture);\n\n        window.removeEventListener(\"orientationchange\", this._onOrientationChange);\n        this.node.off(cc.Node.EventType.TOUCH_END, this._resumeWithGesture, this, true);\n    },\n    // need to debug memory for muliple loading call -----\n    loadWebSounds(gameNode)\n    {\n        this.soundLoadCount = 0;\n        this.gameNode = gameNode;\n        let sounds = [\n            // {id: 'test_sound', src: 'res/import/df/df3d8497-4e8c-4a25-8fb9-e5b70e8c3f88.mp3'}\n        ];\n        var soundMap = {};\n        var soundUuids = [];\n        this.loadedSoundMap = {};\n        for (let i in cc.loader._cache)\n        {\n            let clip = cc.loader._cache[i]._owner;\n            if (clip instanceof cc.AudioClip)\n            {\n                if (clip._nativeAsset instanceof window.Howl) {\n                    this.howlMap[clip._uuid] = clip._nativeAsset;\n                    this.loadedSoundMap[clip.name] = true;\n                    continue;\n                }\n                \n                // dont load the cached background audio session\n                if (this.bgMusicUUID && clip._uuid == this.bgMusicUUID)\n                {\n                    continue;\n                }\n                if (!soundMap[clip.url])\n                {\n                    sounds.push({uuid: clip._uuid, name: clip.name, src: clip.url});\n                    soundMap[clip.url] = true;\n                    soundUuids.push(clip._uuid);\n\n                    this.loadedSoundMap[clip.name] = false;\n                }\n\n            }\n        }\n\n        if (this.releaseCocosSound) cc.loader.release(soundUuids);\n\n        this.totalSound = sounds.length;\n        if (this.totalSound == 0) this.isAllWebSoundLoaded = true; \n        cc.log('this.totalSound === ' + this.totalSound);\n        for (var i = 0; i < sounds.length; i++)\n        {\n            let sound = sounds[i];\n            let howl = new Howl({\n                src: [sound.src],\n                preload: true\n            });\n\n            howl.once('load', this.onWebSoundLoadComplete.bind(this, sound.name));\n            this.howlMap[sound.uuid] = howl;\n        }\n\n        // init user gesture for audio to start\n        this.waitForGesture(gameNode);\n    },\n\n    waitForGesture(gameNode) {\n        if (!window['_v_audio_backgroud_session']) gameNode.on(cc.Node.EventType.TOUCH_END, this.startPlayWithUserGesture, this, true);\n    },\n\n    onWebSoundLoadComplete(e)\n    {\n        this.soundLoadCount++;\n        if (!this.gameNode)\n        {\n            // trick to handle bug from preloading scene. Will resolve it later.\n            return;\n        }\n        this.loadedSoundMap[e] = true;\n\n        var fail = '';\n        for (let k in this.loadedSoundMap)\n        {\n            if (!this.loadedSoundMap[k])\n            {\n                fail = k;\n                break;\n            }\n        }\n        if (window && window['vtrace']) window['vtrace']('fail: ' + fail);\n\n        if (this.soundLoadCount == this.totalSound)\n        {\n            this.isAllWebSoundLoaded = true;\n\n            // all sounds loaded - switch to websound\n            cc.audioEngine.stopAllEffects();\n            cc.audioEngine.stopMusic();\n            if (this.isEnableBGM)\n            {\n                if (!this.currentBGM) this.playMusic(this.bgmMain, true, -1, this.musicOffset);\n                else this.playMusic(this.currentBGM, true, -1, this.musicOffset);\n            }\n        }\n    },\n\n    playHowl(howl, options, id = -1)\n    {\n        if (options.loop) howl.loop(options.loop);\n        if (options.volume) howl.volume(options.volume);\n        if (options.offset) howl.seek(options.offset);\n        return id >= 0 ? howl.play(id) : howl.play();\n    },\n\n    onGameShow()\n    {\n        cc.log(\"WebSound: onGameShow\");\n        this.isGameActive = true;\n        if (this.webSound)\n        {\n            this.resumeContext().then(()=>{\n                if (this.isEnableBGM) {\n                    if (this.musicInstance.pausedOnHide) {\n                        this.musicInstance.pausedOnHide = false;\n                        this.resumeMusic();\n                    }\n                }\n                // resume all sound effects\n                for (var i in this.howlMap )\n                {\n                    let instance = this.howlMap[i];\n                    if (instance == this.musicInstance) continue;\n                    if (instance['_vorgVolume'])\n                    {\n                        instance.volume(instance['_vorgVolume']);\n                        delete instance['_vorgVolume'];\n                        if (instance.pausedOnHide) {\n                            instance.play();\n                            instance.pausedOnHide = false;\n                        }\n                    }\n                }\n            });\n        } else {\n            if (!this.isEnableBGM) {\n                this.stopMusic();\n            }\n        }\n    },\n\n    resumeContext() {\n        const Howler = window.Howler;\n        if (Howler && Howler.ctx && Howler.ctx.state != \"running\") {\n            return Howler.ctx.resume();\n        } \n\n        return Promise.resolve();\n    },\n\n    onGameHide()\n    {\n        cc.log(\"WebSound: onGameHide\");\n        this.isGameActive = false;\n        if (this.webSound)\n        {\n            if (this.musicInstance) {\n                if (this.musicInstance.playing()) {\n                    this.musicInstance.pausedOnHide = true;\n                }\n                this.pauseMusic();\n            }\n            // pause all sound effects\n            for (var i in this.howlMap) {\n                let instance = this.howlMap[i];\n                if (instance != this.musicInstance)\n                {\n                    instance['_vorgVolume'] = instance.volume();\n                    instance.volume(0);\n                    if (instance.playing()) {\n                        instance.pause();\n                        instance.pausedOnHide = true;\n                    }\n                }\n            }\n        }\n    },\n\n    startPlayWithUserGesture()\n    {\n        if (!this.isAllWebSoundLoaded) return;\n        if (!this.currentBGM) this.currentBGM = this.bgmMain;\n        if (!this.currentBGM)\n        {\n            cc.log('WebSoundPlayer::startPlayWithUserGesture this.bgmMain is not initialized.');\n            return;\n        }\n\n        if (this.musicInstance)\n        {\n            this.musicInstance.stop();\n        }\n\n        this.gameNode.runAction(cc.sequence(cc.delayTime(0.1), cc.callFunc(()=>{\n            this.playMusic(this.currentBGM, true, -1, this.musicOffset);\n\n            if (this.musicInstance && this.musicInstance.playing())\n            {\n                this.gameNode.off(cc.Node.EventType.TOUCH_END, this.startPlayWithUserGesture, this, true);\n            }\n\n            if (!this.isEnableBGM && this.musicInstance) this.musicInstance.pause();\n        })));\n        cc.isLoadAllSoundWeb = true;\n    },\n\n    setMusicVolume(volume)\n    {\n        this.musicVolume = volume;\n        if (!this.isEnableBGM) return;\n\n        if (!this.webSound) // audioEngine\n        {\n            cc.audioEngine.setMusicVolume(volume);\n        }\n        else { // web sound ---\n            if (this.musicInstance) this.musicInstance.volume(volume);\n        }\n    },\n\n    setEffectsVolume(volume)\n    {\n        this.effectVolume = volume;\n        if (!this.webSound) // audioEngine\n        {\n            cc.audioEngine.setEffectsVolume(volume);\n        }\n        else { // web sound ---\n            for (var i in this.howlMap) {\n                let instance = this.howlMap[i];\n                if (instance != this.musicInstance) instance.volume(volume);\n            }\n        }\n    },\n\n    playMusic(audio, loop = true, volume = this.musicVolume, offset = 0)\n    {\n        if (volume < 0) volume = this.musicVolume;\n        try {\n            this._playMusic(audio, loop, volume, offset);\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _playMusic(audio, loop = true, volume = this.musicVolume, offset = 0)\n    {\n        if(!audio || (!audio.name && !this.howlMap[audio._uuid]))\n        {\n            cc.log(\"WebSoundPlayer::playMusic invalid audio\", audio);\n            return;\n        }\n        cc.log(\"playMusic ==== \" + audio._uuid + ' volume ' + volume);\n\n        //this.node.getChildByName('debugTf').getComponent('cc.Label').string = this.isEnableBGM;\n        this.currentBGM = audio;\n        this.musicVolume = volume;\n        this.musicOffset = offset;\n        if (!this.webSound)\n        {\n            this.ccMusic = cc.audioEngine.playMusic(audio, loop);\n            if (!cc.sys.isBrowser) // fix native sync issue\n            {\n                if (!this.isEnableBGM) cc.audioEngine.setMusicVolume(0.001);\n                else cc.audioEngine.setMusicVolume(volume);\n            }\n            else {\n                cc.audioEngine.setMusicVolume(volume);\n                if (!this.isEnableBGM) cc.audioEngine.pauseMusic();\n            }\n            if (offset > 0) cc.audioEngine.setCurrentTime(this.ccMusic, offset);\n        }\n        else { // websound\n            if (this.isAllWebSoundLoaded)\n            {\n                if (this.musicInstance) this.musicInstance.stop();\n                this.musicInstance = this.howlMap[audio._uuid];\n                this.bgMusicUUID = audio._uuid;\n                this.musicInstance.loop(loop);\n                this.musicInstance.volume(volume);\n                this.bgMusicId = this.musicInstance.play();\n                if (!this.isEnableBGM || !this.isGameActive) this.pauseMusic();\n                if (offset > 0) this.musicInstance.seek(offset);\n            }\n        }\n    },\n\n    stopMusic()\n    {\n        try {\n            this._stopMusic();\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _stopMusic()\n    {\n        this.currentBGM = null;\n        this.ccMusic = -1;\n        if (!this.webSound)\n        {\n            cc.audioEngine.stopMusic();\n            return;\n        }\n\n        // web sound ---\n        if (this.musicInstance)\n        {\n            this.musicInstance.stop();\n            this.bgMusicId = -1;\n        }\n    },\n\n    pauseMusic()\n    {\n        try {\n            this._pauseMusic();\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _pauseMusic()\n    {\n        if (!this.webSound)\n        {\n            cc.audioEngine.pauseMusic();\n            return;\n        }\n\n        // web sound ---\n        if (this.musicInstance)\n        {\n            if (cc.sys.os == cc.sys.OS_IOS) this.musicInstance.volume(0.001);\n            else this.musicInstance.pause();\n        }\n    },\n\n    resumeMusic()\n    {\n        try {\n            this._resumeMusic();\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _resumeMusic()\n    {\n        if (!this.isEnableBGM) return;\n        if (!this.webSound) // audioEngine\n        {\n            cc.audioEngine.resumeMusic();\n            cc.audioEngine.setMusicVolume(this.musicVolume);\n        }\n        else { // web sound ---\n            if (!this.musicInstance || !this.currentBGM) return;\n            let offset = 0;\n            offset = this.musicInstance.seek();\n            this.musicInstance.stop(this.bgMusicId);\n            this.musicInstance = this.howlMap[this.currentBGM._uuid];\n            this.bgMusicId = this.playHowl(this.musicInstance, {loop: true, volume: this.MUSIC_VOLUME, offset: offset});\n        }\n    },\n\n    fadeMusicTo(time, endVolume) {\n        if (!this.currentBGM) return;\n\n        const volume = { value: this.musicVolume };\n        const tweenFade = cc.tween(volume)\n            .to(time, { value: endVolume }, {\n                progress: (start, end, current, ratio) => {\n                    const currentVolume = Math.round(current * 100) / 100;\n                    this.setMusicVolume(currentVolume);\n                    return start + (end - start) * ratio;\n                }\n            })\n            .start();\n\n        return tweenFade;\n    },\n\n    fadeEffectTo(soundId, time, endVolume) {\n        if (soundId === null || soundId === undefined) return null;\n\n        const volume = { value: this.getVolume(soundId) };\n        const tweenFade = cc.tween(volume)\n            .to(time, { value: endVolume }, {\n                progress: (start, end, current, ratio) => {\n                    const currentVolume = Math.round(current * 100) / 100;\n                    this.setVolume(soundId, currentVolume);\n                    return start + (end - start) * ratio;\n                }\n            })\n            .start();\n\n        return tweenFade;\n    },\n\n    stopEffect(id)\n    {\n        try {\n            this._stopEffect(id);\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _stopEffect(id)\n    {\n        if (!this.webSound) // audioEngine\n        {\n            if (id !== undefined && id !== null) {\n                cc.audioEngine.stopEffect(id);\n            }\n        }\n        else { // web sound ---\n            // need check type more precise\n            if (this._hasAudioContext) {\n                if ((typeof id != 'number') && id) id.stop();\n            } else {\n                this._sfxCacheGesture.forEach((soundObject, index) => {\n                    if (soundObject.sound == id) {\n                        this._sfxCacheGesture.splice(index, 1);\n                    }\n                });\n            }\n        }\n    },\n\n    stopAllEffects()\n    {\n        try {\n            this._stopAllEffects();\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _stopAllEffects()\n    {\n        if (!this.webSound)\n        {\n            // let offset = 0, isLoop = false, musicVolume = 1;\n            // if (this.ccMusic >= 0)\n            // {\n            //     offset = cc.audioEngine.getCurrentTime(this.ccMusic);\n            //     isLoop = cc.audioEngine.isLoop(this.ccMusic);\n            //     musicVolume = cc.audioEngine.getVolume(this.ccMusic);\n            // }\n            // cc.audioEngine.stopAllEffects();\n            // // for fixing sound native issue\n            // if (this.ccMusic >= 0 && this.currentBGM && !cc.sys.isBrowser)\n            // {\n            //     let volume = this.isEnableBGM ? this.musicVolume : 0;\n            //     this.ccMusic = cc.audioEngine.playMusic(this.currentBGM, isLoop);\n            //     cc.audioEngine.setMusicVolume(volume);\n            //     cc.audioEngine.setCurrentTime(this.ccMusic, offset);\n            // }\n\n            for(let i = 0; i<this.playingSounds.length; i++){\n                const soundId = this.playingSounds[i];\n                if(soundId){\n                    // this._stopEffect(soundId);\n                    const state = cc.audioEngine.getState(soundId);\n                    if(state == cc.audioEngine.AudioState.PLAYING){\n                        this._stopEffect(soundId);\n                    }\n                }\n            }\n            this.playingSounds = [];\n        }\n        else { // web sound ---\n            for (var i in this.howlMap) {\n                let howl = this.howlMap[i];\n                if (howl != this.musicInstance) howl.stop();\n            }\n            this._sfxCacheGesture = [];\n        }\n    },\n\n    pauseEffect(soundId){ \n        try {\n            this._pauseEffect(soundId);\n        } catch (e) {\n            cc.log(e.toString());\n        }\n    },\n\n    _pauseEffect(soundId){\n        if (!this.webSound) {\n            cc.audioEngine.pauseEffect(soundId);\n            return;\n        }\n\n        if (soundId) {\n            soundId.pause();\n        }\n    },\n    \n    resumeEffect(soundId){\n        try {\n            this._resumeEffect(soundId);\n        } catch (e) {\n            cc.log(e.toString());\n        }\n    },\n\n    _resumeEffect(soundId){\n        if (!this.webSound) {\n            cc.audioEngine.resumeEffect(soundId);\n            return;\n        }\n\n        if (soundId) {\n            soundId.play();\n        }\n    },\n\n    playSFXClick()\n    {\n        if(!this.sfxClick || (!this.sfxClick.name && !this.howlMap[this.sfxClick._uuid]))\n        {\n            cc.log(\"WebSoundPlayer::playSFXClick invalid sfxClick\");\n            return;\n        }\n        if (!this.isEnableSFX || !this.sfxClick) return;\n        let id;\n        if (!this.webSound)\n        {\n            id = cc.audioEngine.playEffect(this.sfxClick);\n            this.playingSounds.push(id);\n            this._filterPlayingSounds();\n        }\n        else { // web sound ---\n            id = this.howlMap[this.sfxClick._uuid];\n            id.play();\n        }\n        return id;\n    },\n\n    playEffect(sfx, loop = false, volume = this.effectVolume)\n    {\n        let id = null;\n        try {\n            id = this._playEffect(sfx, loop, volume);\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n        return id;\n    },\n\n    _playEffect(sfx, loop = false, volume = this.effectVolume)\n    {\n        if (!this.isGameActive) return;\n        if(!sfx || (!sfx.name && !this.howlMap[sfx._uuid]))\n        {\n            cc.log(\"WebSoundPlayer::playEffect invalid sfx\");\n            return;\n        }\n\n        if (!this.isEnableSFX) return;\n        let id = null;\n        if (!this.webSound)\n        {\n            id = cc.audioEngine.playEffect(sfx, loop);\n            this.playingSounds.push(id);\n            this._filterPlayingSounds();\n        }\n        else { // web sound ---\n            if (this.isAllWebSoundLoaded)\n            {\n                id = this.howlMap[sfx._uuid];\n                if (this._hasAudioContext) {\n                    id.loop(loop);\n                    id.volume(volume);\n                    id.play();\n                } else {\n                    this._sfxCacheGesture.push({ sound: id, startTime: this._timer, duration: id._duration, loop, volume });\n                }\n            }\n        }\n        return id;\n    },\n    _filterPlayingSounds() {\n        if (this.playingSounds.length <= 12) return;\n        this.playingSounds = this.playingSounds.filter(id => {\n            let state = cc.audioEngine.getState(id);\n            return (state === cc.audioEngine.AudioState.PLAYING) || (state === cc.audioEngine.AudioState.PAUSED);\n        })\n    },\n\n    playSFX(sfx)\n    {\n        return this.playEffect(sfx);\n    },\n\n    playSound(audio, loop = false, volume = this.SOUND_EFFECT_VOLUME)\n    {\n        let id = null;\n        try {\n            id = this._playSound(audio, loop, volume);\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n        return id;\n    },\n\n    _playSound(audio, loop = false, volume = this.SOUND_EFFECT_VOLUME)\n    {\n        if (!this.isGameActive) return;\n        if(!audio || (!audio.name && !this.howlMap[audio._uuid]))\n        {\n            cc.log(\"WebSoundPlayer::playSound invalid audio\");\n            return;\n        }\n\n        if (!this.isEnableSFX) return null;\n        let id = null;\n        if (!this.webSound)\n        {\n            id = cc.audioEngine.play(audio, loop, volume);\n            this.playingSounds.push(id);\n            this._filterPlayingSounds();\n        }\n        else { // web sound ---\n            if (this.isAllWebSoundLoaded)\n            {\n                id = this.howlMap[audio._uuid];\n                if (this._hasAudioContext) {\n                    id.loop(loop);\n                    id.volume(volume);\n                    id.play();\n                } else {\n                    this._sfxCacheGesture.push({ sound: id, startTime: this._timer, duration: id._duration, loop, volume });\n                }\n            }\n        }\n        return id;\n    },\n\n    stopSound(id)\n    {\n        try {\n            this._stopSound(id);\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _stopSound(id)\n    {\n        this.stopEffect(id);\n    },\n\n    stopAllAudio()\n    {\n        try {\n            this._stopAllAudio();\n        }\n        catch(e)\n        {\n            cc.log(e.toString());\n        }\n    },\n\n    _stopAllAudio()\n    {\n        this.currentBGM = null;\n        this.ccMusic = -1;\n        if (!this.webSound)\n        {\n            cc.audioEngine.stopAll();\n        }\n        else {// web sound ---\n            this.stopAllEffects();\n            if (this.musicInstance) this.musicInstance.pause();\n        }\n    },\n\n    sfxToggle()\n    {\n        this.setEffectEnable(!this.isEnableSFX);\n    },\n\n    setEffectEnable(enable)\n    {\n        this.isEnableSFX = enable;\n        if (this.node.gSlotDataStore) this.node.gSlotDataStore.isEnableSFX = this.isEnableSFX;\n        if (this.isWebSoundClient2) {\n            cc.sys.localStorage.setItem(this.storageKeySFX, this.isEnableSFX ? \"1\" : \"0\");\n        } else {\n            cc.sys.localStorage.setItem(this.storageKeySFX, this.isEnableSFX);\n        }\n\n        if (!this.isEnableSFX)\n        {\n            this.stopAllEffects();\n        }\n    },\n\n    bgmToggle()\n    {\n        this.setBgmEnable(!this.isEnableBGM);\n    },\n\n    setBgmEnable(enable)\n    {\n        this.isEnableBGM = enable;\n        if (this.node.gSlotDataStore) this.node.gSlotDataStore.isEnableBGM = this.isEnableBGM;\n\n        if (this.isWebSoundClient2) {\n            cc.sys.localStorage.setItem(this.storageKeyBGM, this.isEnableBGM ? \"1\" : \"0\");\n        } else {\n            cc.sys.localStorage.setItem(this.storageKeyBGM, this.isEnableBGM);\n        }\n\n        if(this.enableMusicFunc){\n            clearTimeout(this.enableMusicFunc);\n        }\n        this.enableMusicFunc = setTimeout(()=>{\n            if (this.isEnableBGM)\n            {\n                if (!this.currentBGM) this.playMainBGM();\n                else this.resumeMusic();\n            } else {\n                this.pauseMusic();\n            }\n            this.enableMusicFunc = null;\n        }, 100);\n    },\n\n    setVolume(id, volume = 1.0)\n    {\n        if (id !== 0 && !id) return false;\n        if (!this.webSound) // audioEngine\n        {\n            cc.audioEngine.setVolume(id, volume);\n        }\n        else { // web sound ---       \n            // need check type more precise\n            if (typeof id != 'number') id.volume(volume);\n        }\n        return true;\n    },\n\n    getVolume(id)\n    {\n        if (id !== 0 && !id) return 0;\n        if (!this.webSound) // audioEngine\n        {\n            return cc.audioEngine.getVolume(id);\n        }\n        else { // web sound ---       \n            // need check type more precise\n            if (typeof id != 'number') return id.volume();\n        }\n    },\n\n    getPlayState(id)\n    {\n        if (id !== 0 && !id) return SoundStateEnum.NONE;\n        let state = SoundStateEnum.NONE;\n        if (!this.webSound) // audioEngine\n        {\n            switch(cc.audioEngine.getState(id))\n            {\n                case cc.audioEngine.AudioState.PLAYING:\n                    state = SoundStateEnum.PLAYING;\n                    break;\n            }\n        }\n        else { // web sound ---       \n            // need check type more precise\n            if (typeof id != 'number')\n            {\n                if (id.playing()) state = SoundStateEnum.PLAYING;\n            }\n        }\n        return state;\n    },\n\n    getMusicState()\n    {\n        let id = this.webSound? this.musicInstance : this.ccMusic;\n        return this.getPlayState(id);\n    },\n\n    // return in seconds\n    getDuration(id)\n    {\n        if (id === null || id === undefined) return 0;\n        if (!this.webSound) // audioEngine\n        {\n            return cc.audioEngine.getDuration(id);\n        }\n        else { // web sound ---       \n            // need check type more precise\n            if (typeof id != 'number') return id.duration();\n        }\n    },\n\n    // update (dt) {},\n\n    onDestroy()\n    {\n        if (this.gameNode) this.gameNode.off(cc.Node.EventType.TOUCH_END, this.startPlayWithUserGesture, this, true);\n        cc.game.off(cc.game.EVENT_SHOW, this.onGameShow, this);\n        cc.game.off(cc.game.EVENT_HIDE, this.onGameHide, this);\n        if (this.webSound)\n        {\n            for (let i in this.howlMap)\n            {\n                if (this.howlMap[i] != this.musicInstance || !this.keepAudioSession) this.howlMap[i].unload();\n            }\n\n            if (this.keepAudioSession)\n            {\n                if(this.musicInstance)\n                {\n                    this.musicInstance.volume(0.001);\n                    window['_v_audio_backgroud_session'] =\n                        {\n                            uuid: this.bgMusicUUID,\n                            bgMusicId: this.bgMusicId,\n                            instance: this.musicInstance\n                        };\n                }\n            }\n            else window['_v_audio_backgroud_session'] = null;\n        }\n        this.playingSounds = [];\n        clearTimeout(this.enableMusicFunc);\n    },\n});\n\nmodule.exports = {\n    SoundStateEnum,\n    SoundStorageKeys,\n    WebSoundPlayer\n};\n"]}