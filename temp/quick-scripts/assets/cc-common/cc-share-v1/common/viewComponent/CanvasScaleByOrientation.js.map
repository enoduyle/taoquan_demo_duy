{"version":3,"sources":["CanvasScaleByOrientation.js"],"names":["cc","Class","extends","Component","properties","autoOrientation","isPortrait","canvas","Canvas","fitByOrientation","useCustomDesignResolution","customDSWidth","customDSHeight","widgetNodes","type","Widget","default","isDebug","onLoad","_thisOnResized","onScreenResized","bind","sys","isMobile","window","addEventListener","view","on","scaleCanvasByOrientation","isNative","divFullscreen","document","getElementById","style","visibility","setOrientation","macro","ORIENTATION_AUTO","ORIENTATION_PORTRAIT","ORIENTATION_LANDSCAPE","start","eventResize","Event","dispatchEvent","updateForLandscape","vjsb","os","OS_ANDROID","node","rotation","fs","getFrameSize","scaleY","height","width","scaleX","log","alignWithScreen","loadConfigAsync","require","getConfig","LOGIN_IFRAME","designRatio","designResolution","frameSize","isLandscape","isLandscapeScreen","screenRatio","windowRatio","innerWidth","innerHeight","isBrowser","fitHeight","fitWidth","rotateRootPortraitGame","length","i","updateAlignment","isLandScapeView","children","forEach","child","getComponent","Camera","angle","scaleCanvasCallback","scheduleOnce","onDestroy","removeEventListener","off","unschedule","matchMedia","matches"],"mappings":"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","file":"CanvasScaleByOrientation.js","sourceRoot":"../../../../../../../assets/cc-common/cc-share-v1/common/viewComponent","sourcesContent":["\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        autoOrientation: false,\n        isPortrait: true,\n        canvas: cc.Canvas,\n        fitByOrientation: true,\n        useCustomDesignResolution: false,\n        customDSWidth: 1280,\n        customDSHeight: 720,\n        widgetNodes: {\n            type: cc.Widget,\n            default: [],\n        },\n        isDebug: false\n    },\n\n    onLoad() {\n        this._thisOnResized = this.onScreenResized.bind(this);\n        if (cc.sys.isMobile) {\n            window.addEventListener('resize', this._thisOnResized);\n        }\n        else {\n            cc.view.on('canvas-resize', this._thisOnResized);\n        }\n        this.scaleCanvasByOrientation();\n        if (!cc.sys.isNative) {\n            var divFullscreen = document.getElementById('div_full_screen');\n            if (this.isPortrait) {\n                if (divFullscreen) {\n                    divFullscreen.style.visibility = \"hidden\";\n                }\n            }\n\n            if(this.autoOrientation){\n                cc.view.setOrientation(cc.macro.ORIENTATION_AUTO);\n            }else if(this.isPortrait){\n                cc.view.setOrientation(cc.macro.ORIENTATION_PORTRAIT);\n            }else{\n                cc.view.setOrientation(cc.macro.ORIENTATION_LANDSCAPE);\n            }\n        }\n    },\n\n    start(){\n        if(cc.sys.isMobile){\n            const eventResize = new Event('gameShow');\n            window.dispatchEvent(eventResize);\n        }\n        this.updateForLandscape();\n    }, \n\n    updateForLandscape() {\n        const vjsb = window['vjsb'];\n        if (vjsb && cc.sys.os == cc.sys.OS_ANDROID && !this.isPortrait) {\n            this.node.rotation = 90;\n            let fs = cc.view.getFrameSize();\n            this.node.scaleY = fs.height/fs.width;\n            this.node.scaleX = this.node.scaleY;\n        }\n    },\n\n    scaleCanvasByOrientation() {\n        if (this.autoOrientation) {\n            if (cc.view.getFrameSize().width < cc.view.getFrameSize().height) {\n                this.isPortrait = true;\n            } else {\n                this.isPortrait = false;\n            }\n        } else {\n            if (this.isPortrait) {\n                cc.view.setOrientation(cc.macro.ORIENTATION_PORTRAIT);\n            } else {\n                cc.view.setOrientation(cc.macro.ORIENTATION_LANDSCAPE);\n            }\n        }\n\n        if (this.canvas) {\n            this.isDebug && cc.log(\"Canvas after update: \");\n            this.isDebug && cc.log(this.canvas);\n\n            this.canvas.alignWithScreen();\n            if (this.fitByOrientation) {\n                const loadConfigAsync = require('loadConfigAsync');\n                const {LOGIN_IFRAME} = loadConfigAsync.getConfig();\n\n                const designRatio = this.useCustomDesignResolution && LOGIN_IFRAME ? this.customDSWidth/this.customDSHeight : this.canvas.designResolution.width / this.canvas.designResolution.height;\n                const frameSize = cc.view.getFrameSize();\n                const isLandscape = this.isLandscapeScreen();\n                let screenRatio = frameSize.width / frameSize.height;\n                this.isDebug && cc.log(`View size:${frameSize}, Design Resolution: W: ${this.canvas.designResolution.width}, H: ${this.canvas.designResolution.height},  Screen Ratio: ${screenRatio}, Design Ratio: ${designRatio}`);\n                if (this.isPortrait) {\n                    const windowRatio = (!isLandscape)? (window.innerWidth / window.innerHeight) : (window.innerHeight / window.innerWidth);\n                    screenRatio = (cc.sys.isMobile && cc.sys.isBrowser && windowRatio < screenRatio)? windowRatio : screenRatio;\n                    if (screenRatio < designRatio) {\n                        this.canvas.fitHeight = false;\n                        this.canvas.fitWidth = true;\n                        this.isDebug && cc.log(`CANVAS FIT WIDTH`);\n                    } else {\n                        this.canvas.fitHeight = true;\n                        this.canvas.fitWidth = false;\n                        this.isDebug && cc.log(`CANVAS FIT HEIGHT`);\n                    }\n                    this.rotateRootPortraitGame();\n                } else {\n                    const windowRatio = isLandscape? (window.innerWidth / window.innerHeight) : (window.innerHeight / window.innerWidth);\n                    screenRatio = (cc.sys.isMobile && cc.sys.isBrowser && windowRatio > screenRatio)? windowRatio : screenRatio;\n                    if (screenRatio < designRatio) {\n                        this.canvas.fitHeight = false;\n                        this.canvas.fitWidth = true;\n                        this.isDebug && cc.log(isLandscape? `LANDSCAPE ORIENTATION - CANVAS FIT WIDTH` : `PORTRAIT ORIENTATION - CANVAS FIT WIDTH`);\n                    } else {\n                        this.canvas.fitHeight = true;\n                        this.canvas.fitWidth = false;\n                        this.isDebug && cc.log(isLandscape? `LANDSCAPE ORIENTATION - CANVAS FIT HEIGHT` : `PORTRAIT ORIENTATION - CANVAS FIT HEIGHT`);\n                    }\n                }\n            }\n        } else {\n            this.isDebug && cc.log(`No canvas component`);\n        }\n\n        if (this.widgetNodes && this.widgetNodes.length > 0) {\n            for (let i = 0; i < this.widgetNodes.length; i++) {\n                this.widgetNodes[i].updateAlignment();\n            }\n        }\n    },\n\n    rotateRootPortraitGame() {\n        if (!this.isPortrait) return;\n        if (cc.sys.isMobile && cc.sys.isBrowser) {\n            const isLandScapeView = this.isLandscapeScreen();\n            this.node.children.forEach(child => {\n                if (!child.getComponent(cc.Camera)) {\n                    child.angle = isLandScapeView ? 180 : 0;\n                }\n            });\n        }\n    },\n\n    onScreenResized() {\n        this.scaleCanvasCallback = ()=> {\n            this.scaleCanvasByOrientation();\n            this.scaleCanvasCallback = null;\n        };\n        this.scheduleOnce(this.scaleCanvasCallback, 0.5);\n    },\n\n    onDestroy() {\n        if (cc.sys.isMobile) {\n            window.removeEventListener('resize', this._thisOnResized);\n        }\n        else {\n            cc.view.off('canvas-resize', this._thisOnResized);\n        }\n        if(this.scaleCanvasCallback) this.unschedule(this.scaleCanvasCallback);\n        this.scaleCanvasCallback = null;\n    },\n\n    isLandscapeScreen() {\n        if(cc.sys.isBrowser && cc.sys.isMobile && typeof window.matchMedia === 'function') {\n            if (window.matchMedia(\"(orientation: landscape)\").matches) {\n                return true;\n            }\n            if (window.matchMedia(\"(orientation: portrait)\").matches) {\n                return false;\n            }\n        }\n        return true;\n    },\n});\n"]}