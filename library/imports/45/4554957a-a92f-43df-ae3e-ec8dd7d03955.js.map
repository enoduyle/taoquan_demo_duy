{"version":3,"sources":["../../../../../../assets/cc-common/cc-lobby-999/HotUpdate/assets/cc-common/cc-lobby-999/HotUpdate/HotUpdate.ts"],"names":[],"mappings":";;;;;AAAA,6CAA4C;AAE5C,IAAM,GAAG,GAAS,MAAO,CAAC,GAAG,CAAC;AAExB,IAAA,kBAAqC,EAAnC,oBAAO,EAAE,sBAA0B,CAAC;AAG5C;IAA+B,6BAAY;IAD3C;QAAA,qEA8QC;QA1QG,WAAK,GAAgB,IAAK,CAAC;QAG3B,sBAAgB,GAAG,kBAAkB,CAAC;QAGtC,yBAAmB,GAAG,eAAe,CAAC;QAGtC,kBAAY,GAAG,CAAC,CAAC;QAGjB,kBAAY,GAAG,IAAI,CAAC;QAMZ,eAAS,GAAG,KAAK,CAAC;QAClB,eAAS,GAAG,KAAK,CAAC;QAClB,kBAAY,GAAG,EAAE,CAAC;QAClB,SAAG,GAAQ,IAAK,CAAC;QACjB,qBAAe,GAAG,IAAI,CAAC;QACvB,gBAAU,GAAG,CAAC,CAAC;QA+MvB,0BAAoB,GAAG,UAAU,QAAgB,EAAE,QAAgB;YAC/D,OAAO,CAAC,GAAG,CAAC,6CAA2C,QAAQ,sBAAiB,QAAU,CAAC,CAAC;YAC5F,IAAI,EAAE,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAC7B,IAAI,EAAE,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAC7B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;gBAChC,IAAI,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;gBACxB,IAAI,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC;gBAC/B,IAAI,CAAC,KAAK,CAAC,EAAE;oBACT,SAAS;iBACZ;qBACI;oBACD,OAAO,CAAC,GAAG,CAAC,CAAC;iBAChB;aACJ;YACD,IAAI,EAAE,CAAC,MAAM,GAAG,EAAE,CAAC,MAAM,EAAE;gBACvB,OAAO,CAAC,CAAC,CAAC;aACb;iBACI;gBACD,OAAO,CAAC,CAAC;aACZ;QACL,CAAC,CAAC;;IAgBN,CAAC;IA5PG,sBAAW,iCAAU;aAArB;YACI,OAAO,IAAI,CAAC,SAAS,CAAC;QAC1B,CAAC;;;OAAA;IASD,0BAAM,GAAN;QACI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QAE/B,IAAI,CAAC,GAAG,EAAE;YACN,OAAO;SACV;QACD,IAAI,YAAY,GAAG,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,GAAG,CAAC,SAAS,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC;QACzE,IAAI,CAAC,YAAY,GAAG,KAAG,YAAY,GAAG,IAAI,CAAC,mBAAqB,CAAC;QACjE,OAAO,CAAC,GAAG,CAAC,kCAAkC,GAAG,IAAI,CAAC,YAAY,CAAC,CAAC;QACpE,IAAI,CAAC,GAAG,GAAG,IAAI,GAAG,CAAC,aAAa,CAAC,EAAE,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,oBAAoB,CAAC,CAAC;QAEnF,wBAAwB;QACxB,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAE9D,IAAI,CAAC,YAAY,EAAE,CAAC;QACpB,IAAI,CAAC,WAAW,EAAE,CAAC;IACvB,CAAC;IAED,qCAAiB,GAAjB,UAAkB,IAAY,EAAE,KAAU;QACtC,IAAI,UAAU,GAAG,KAAK,CAAC,UAAU,CAAC;QAClC,IAAI,YAAY,GAAG,KAAK,CAAC,IAAI,CAAC;QAC9B,IAAI,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC;QACtB,IAAI,UAAU,EAAE;YACZ,EAAE,CAAC,GAAG,CAAC,0BAAwB,YAAc,CAAC,CAAC;YAC/C,OAAO,IAAI,CAAC;SACf;aACI;YACD,8CAA8C;YAC9C,IAAI,QAAQ,GAAG,GAAG,CAAC,SAAS,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;YAC/C,IAAI,IAAI,IAAI,QAAQ,EAAE;gBAClB,EAAE,CAAC,GAAG,CAAC,0BAAwB,YAAc,CAAC,CAAC;gBAC/C,OAAO,IAAI,CAAC;aACf;YACD,EAAE,CAAC,GAAG,CAAC,0BAAwB,YAAY,SAAI,IAAI,SAAI,QAAU,CAAC,CAAC;YACnE,OAAO,KAAK,CAAC;SAChB;IACL,CAAC;IAED,gCAAY,GAAZ;QACI,IAAI,EAAE,CAAC,GAAG,CAAC,QAAQ,EAAE;YACjB,IAAI,GAAG,CAAC,SAAS,CAAC,WAAW,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE;gBAClD,IAAI,IAAI,GAAG,GAAG,CAAC,SAAS,CAAC,mBAAmB,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;gBACpE,EAAE,CAAC,GAAG,CAAC,2BAAyB,IAAM,CAAC,CAAC;gBACxC,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;aACpC;iBACI;gBACD,EAAE,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;aAChC;SACJ;IACL,CAAC;IAED,0CAAsB,GAAtB,UAAuB,iBAAiB;QACpC,IAAI,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,aAAa,CAAC,KAAK,CAAC,QAAQ,EAAE;YAC1D,EAAE,CAAC,GAAG,CAAC,sBAAsB,CAAC,CAAC;YAC/B,IAAI,QAAQ,GAAG,IAAI,GAAG,CAAC,QAAQ,CAAC,iBAAiB,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;YACtE,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,QAAQ,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;SAC3D;IACL,CAAC;IAED,+BAAW,GAAX;QACI,IAAI,CAAC,IAAI,CAAC,GAAG;YAAE,OAAO;QACtB,IAAI,IAAI,CAAC,SAAS,EAAE;YAChB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,kBAAkB,CAAC;YAC5C,OAAO;SACV;QAED,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,aAAa,CAAC,KAAK,CAAC,QAAQ,EAAE;YAC1D,EAAE,CAAC,GAAG,CAAC,oDAAoD,CAAC,CAAC;SAChE;QACD,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,gBAAgB,EAAE,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC,QAAQ,EAAE,EAAE;YACzE,EAAE,CAAC,GAAG,CAAC,mCAAmC,CAAC,CAAC;YAC5C,OAAO;SACV;QACD,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACnD,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC;IAC3B,CAAC;IAED,2BAAO,GAAP,UAAQ,KAAU;QACd,OAAO,CAAC,GAAG,CAAC,QAAQ,GAAG,KAAK,CAAC,YAAY,EAAE,CAAC,CAAC;QAC7C,IAAI,aAAa,GAAG,KAAK,CAAC;QAC1B,QAAQ,KAAK,CAAC,YAAY,EAAE,EAAE;YAC1B,KAAK,GAAG,CAAC,kBAAkB,CAAC,uBAAuB;gBAC/C,EAAE,CAAC,GAAG,CAAC,mDAAmD,CAAC,CAAC;gBAC5D,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,uBAAuB,CAAC;YACpD,KAAK,GAAG,CAAC,kBAAkB,CAAC,oBAAoB;gBAC5C,EAAE,CAAC,GAAG,CAAC,qDAAqD,CAAC,CAAC;gBAC9D,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,kBAAkB;gBAC1C,EAAE,CAAC,GAAG,CAAC,oDAAoD,CAAC,CAAC;gBAC7D,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,iBAAiB;gBACzC,EAAE,CAAC,GAAG,CAAC,mBAAmB,CAAC,CAAC;gBAC5B,aAAa,GAAG,IAAI,CAAC;gBACrB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;gBAC9B,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,GAAG,CAAC,CAAC;gBACrC,MAAM;YACV;gBACI,OAAO;SACd;QAED,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAK,CAAC,CAAC;QACjC,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QAEvB,IAAI,aAAa,IAAI,IAAI,CAAC,YAAY,EAAE;YACpC,IAAI,CAAC,SAAS,EAAE,CAAC;SACpB;IACL,CAAC;IAED,6BAAS,GAAT;QACI,IAAI,IAAI,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;YAC7B,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;YAEtB,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YACpD,IAAI,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,aAAa,CAAC,KAAK,CAAC,QAAQ,EAAE;gBAC1D,EAAE,CAAC,GAAG,CAAC,oDAAoD,CAAC,CAAC;aAChE;YACD,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;YACpB,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC;SACrB;IACL,CAAC;IAED,4BAAQ,GAAR,UAAS,KAAU;QACf,IAAI,WAAW,GAAG,KAAK,CAAC;QACxB,IAAI,MAAM,GAAG,KAAK,CAAC;QACnB,QAAQ,KAAK,CAAC,YAAY,EAAE,EAAE;YAC1B,KAAK,GAAG,CAAC,kBAAkB,CAAC,uBAAuB;gBAC/C,EAAE,CAAC,GAAG,CAAC,mDAAmD,CAAC,CAAC;gBAC5D,MAAM,GAAG,IAAI,CAAC;gBACd,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,kBAAkB;gBAC1C,IAAI,OAAO,GAAG,KAAK,CAAC,UAAU,EAAE,CAAC;gBAEjC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE;oBACjB,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,GAAG,OAAO,CAAC;oBAC3C,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,gBAAc,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,GAAG,CAAC,MAAG,CAAA;iBACtE;gBACD,IAAI,GAAG,GAAG,KAAK,CAAC,UAAU,EAAE,CAAC;gBAC7B,IAAI,GAAG,EAAE;oBACL,EAAE,CAAC,GAAG,CAAC,mBAAiB,GAAK,CAAC,CAAC;iBAClC;gBACD,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,uBAAuB,CAAC;YACpD,KAAK,GAAG,CAAC,kBAAkB,CAAC,oBAAoB;gBAC5C,EAAE,CAAC,GAAG,CAAC,qDAAqD,CAAC,CAAC;gBAC9D,MAAM,GAAG,IAAI,CAAC;gBACd,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,kBAAkB;gBAC1C,EAAE,CAAC,GAAG,CAAC,oDAAoD,CAAC,CAAC;gBAC7D,MAAM,GAAG,IAAI,CAAC;gBACd,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,eAAe;gBACvC,EAAE,CAAC,GAAG,CAAC,sBAAoB,KAAK,CAAC,UAAU,EAAI,CAAC,CAAC;gBACjD,WAAW,GAAG,IAAI,CAAC;gBACnB,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,aAAa;gBACrC,EAAE,CAAC,GAAG,CAAC,oBAAkB,KAAK,CAAC,UAAU,EAAI,CAAC,CAAC;gBAC/C,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;gBACvB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;gBACtB,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,cAAc;gBACtC,EAAE,CAAC,GAAG,CAAC,yBAAuB,KAAK,CAAC,UAAU,EAAE,UAAK,KAAK,CAAC,UAAU,EAAI,CAAC,CAAC;gBAC3E,MAAM;YACV,KAAK,GAAG,CAAC,kBAAkB,CAAC,gBAAgB;gBACxC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,UAAU,EAAE,CAAC;gBAC5C,MAAM;YACV;gBACI,MAAM;SACb;QAED,IAAI,MAAM,EAAE;YACR,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAK,CAAC,CAAC;YACjC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;SAC1B;QAED,IAAI,IAAI,CAAC,SAAS,EAAE;YAChB,IAAI,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,YAAY,EAAE;gBACrC,IAAI,CAAC,UAAU,IAAI,CAAC,CAAC;gBACrB,IAAI,CAAC,KAAK,EAAE,CAAC;aAChB;iBACI;gBACD,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,yDAAyD,CAAC;aACtF;SACJ;QAED,IAAI,WAAW,EAAE;YACb,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAK,CAAC,CAAC;YACjC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAE5B,IAAI,WAAW,GAAG,GAAG,CAAC,SAAS,CAAC,cAAc,EAAE,CAAC;YACjD,IAAI,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC,cAAc,EAAE,CAAC;YAC5D,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC;YACtC,KAAK,CAAC,SAAS,CAAC,OAAO,CAAC,KAAK,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC;YAErD,YAAY,CAAC,OAAO,CAAC,sBAAsB,EAAE,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC,CAAC;YAC1E,GAAG,CAAC,SAAS,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;YAE1C,UAAU,CAAC;gBACP,EAAE,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;YACtB,CAAC,EAAE,IAAI,CAAC,CAAA;SACX;IACL,CAAC;IAwBD,yBAAK,GAAL;QACI,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,SAAS,EAAE;YACnC,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YACvB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,wBAAwB,CAAC;YAClD,IAAI,CAAC,GAAG,CAAC,oBAAoB,EAAE,CAAC;SACnC;IACL,CAAC;IAED,6BAAS,GAAT;QACI,IAAI,IAAI,CAAC,eAAe,EAAE;YACtB,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAK,CAAC,CAAC;YACjC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;SAC/B;IACL,CAAC;IAzQD;QADC,QAAQ,CAAC,yBAAW,CAAC;4CACK;IAG3B;QADC,QAAQ;uDAC6B;IAGtC;QADC,QAAQ;0DAC6B;IAGtC;QADC,QAAQ;mDACQ;IAGjB;QADC,QAAQ;mDACW;IAfX,SAAS;QADrB,OAAO;OACK,SAAS,CA6QrB;IAAD,gBAAC;CA7QD,AA6QC,CA7Q8B,EAAE,CAAC,SAAS,GA6Q1C;AA7QY,8BAAS","file":"","sourceRoot":"../../../../../../assets/cc-common/cc-lobby-999/HotUpdate","sourcesContent":["import { UpdatePanel } from './UpdatePanel';\n\nconst jsb = (<any>window).jsb;\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport class HotUpdate extends cc.Component {\n\n    @property(UpdatePanel)\n    panel: UpdatePanel = null!;\n\n    @property\n    manifestFileName = 'project.manifest';\n\n    @property\n    storageDownloadPath = 'eno-hotupdate';\n\n    @property\n    maximumRetry = 3;\n\n    @property\n    autodownload = true;\n\n    public get IsUpdating(): boolean {\n        return this._updating;\n    }\n\n    private _updating = false;\n    private _canRetry = false;\n    private _storagePath = '';\n    private _am: any = null!;\n    private _updateListener = null;\n    private _failCount = 0;\n\n    onLoad() {\n        this.panel.node.active = false;\n        \n        if (!jsb) {\n            return;\n        }\n        let writablePath = jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/';\n        this._storagePath = `${writablePath}${this.storageDownloadPath}`;\n        console.log('Storage path for remote asset : ' + this._storagePath);\n        this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\n\n        //TODO MD5 compare check\n        this._am.setVerifyCallback(this._verifyFileHandle.bind(this));\n\n        this.loadManifest();\n        this.checkUpdate();\n    }\n\n    _verifyFileHandle(path: string, asset: any) {\n        var compressed = asset.compressed;\n        var relativePath = asset.path;\n        var size = asset.size;\n        if (compressed) {\n            cc.log(`Verification passed: ${relativePath}`);\n            return true;\n        }\n        else {\n            //TODO implement md5 content, it's too lagging\n            var fileSize = jsb.fileUtils.getFileSize(path);\n            if (size == fileSize) {\n                cc.log(`Verification passed: ${relativePath}`);\n                return true;\n            }\n            cc.log(`Verification failed: ${relativePath} ${size}/${fileSize}`);\n            return false;\n        }\n    }\n\n    loadManifest() {\n        if (cc.sys.isNative) {\n            if (jsb.fileUtils.isFileExist(this.manifestFileName)) {\n                let path = jsb.fileUtils.fullPathForFilename(this.manifestFileName);\n                cc.log(`find manifest at path ${path}`);\n                this._am.loadLocalManifest(path);\n            }\n            else {\n                cc.log(`cant find manifest`);\n            }\n        }\n    }\n\n    loadManifestFromString(customManifestStr) {\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n            cc.log('load custom manifest');\n            var manifest = new jsb.Manifest(customManifestStr, this._storagePath);\n            this._am.loadLocalManifest(manifest, this._storagePath);\n        }\n    }\n\n    checkUpdate() {\n        if (!this._am) return;\n        if (this._updating) {\n            this.panel.info.string = 'Checking version';\n            return;\n        }\n\n        this._updating = true;\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n            cc.log(`Failed to checkUpdate, need to load manifest first`);\n        }\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\n            cc.log(`Failed to load local manifest ...`);\n            return;\n        }\n        this._am.setEventCallback(this.checkCb.bind(this));\n        this._am.checkUpdate();\n    }\n\n    checkCb(event: any) {\n        console.log('Code: ' + event.getEventCode());\n        let hasNewVersion = false;\n        switch (event.getEventCode()) {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                cc.log(\"No local manifest file found, hot update skipped.\");\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                cc.log(\"Fail to download manifest file, hot update skipped.\");\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                cc.log(\"Already up to date with the latest remote version.\");\n                break;\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\n                cc.log('New version found');\n                hasNewVersion = true;\n                this.panel.node.active = true;\n                this.panel.byteProgress.progress = 0;\n                break;\n            default:\n                return;\n        }\n\n        this._am.setEventCallback(null!);\n        this._updating = false;\n\n        if (hasNewVersion && this.autodownload) {\n            this.hotUpdate();\n        }\n    }\n\n    hotUpdate() {\n        if (this._am && !this._updating) {\n            this._updating = true;\n\n            this._am.setEventCallback(this.updateCb.bind(this));\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n                cc.log(`Failed to load hotupdate, need load manifest first`);\n            }\n            this._failCount = 0;\n            this._am.update();\n        }\n    }\n\n    updateCb(event: any) {\n        var doFinishJob = false;\n        var failed = false;\n        switch (event.getEventCode()) {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                cc.log(`No local manifest file found, hot update skipped.`);\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\n                let percent = event.getPercent();\n\n                if (!isNaN(percent)) {\n                    this.panel.byteProgress.progress = percent;\n                    this.panel.info.string = `Updating...${Math.floor(percent * 100)}%`\n                }\n                var msg = event.getMessage();\n                if (msg) {\n                    cc.log(`Updated file: ${msg}`);\n                }\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                cc.log(`Fail to download manifest file, hot update skipped.`);\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                cc.log(`Already up to date with the latest remote version.`);\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\n                cc.log(`Update finished. ${event.getMessage()}`);\n                doFinishJob = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FAILED:\n                cc.log(`Update failed. ${event.getMessage()}`);\n                this._updating = false;\n                this._canRetry = true;\n                break;\n            case jsb.EventAssetsManager.ERROR_UPDATING:\n                cc.log(`Asset update error: ${event.getAssetId()}, ${event.getMessage()}`);\n                break;\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\n                this.panel.info.string = event.getMessage();\n                break;\n            default:\n                break;\n        }\n\n        if (failed) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            this._updating = false;\n        }\n\n        if (this._canRetry) {\n            if (this._failCount < this.maximumRetry) {\n                this._failCount += 1;\n                this.retry();\n            }\n            else {\n                this.panel.info.string = \"Failed to update new version, restart game to try again\";\n            }\n        }\n\n        if (doFinishJob) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n\n            var searchPaths = jsb.fileUtils.getSearchPaths();\n            var newPaths = this._am.getLocalManifest().getSearchPaths();\n            console.log(JSON.stringify(newPaths));\n            Array.prototype.unshift.apply(searchPaths, newPaths);\n\n            localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\n            jsb.fileUtils.setSearchPaths(searchPaths);\n\n            setTimeout(() => {\n                cc.game.restart();\n            }, 1000)\n        }\n    }\n\n    versionCompareHandle = function (versionA: string, versionB: string) {\n        console.log(`JS Custom Version Compare: version A is ${versionA} version B is ${versionB}`);\n        var vA = versionA.split('.');\n        var vB = versionB.split('.');\n        for (var i = 0; i < vA.length; ++i) {\n            var a = parseInt(vA[i]);\n            var b = parseInt(vB[i] || '0');\n            if (a === b) {\n                continue;\n            }\n            else {\n                return a - b;\n            }\n        }\n        if (vB.length > vA.length) {\n            return -1;\n        }\n        else {\n            return 0;\n        }\n    };\n\n    retry() {\n        if (!this._updating && this._canRetry) {\n            this._canRetry = false;\n            this.panel.info.string = `Retry failed Assets...`;\n            this._am.downloadFailedAssets();\n        }\n    }\n\n    onDestroy() {\n        if (this._updateListener) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n        }\n    }\n}\n"]}