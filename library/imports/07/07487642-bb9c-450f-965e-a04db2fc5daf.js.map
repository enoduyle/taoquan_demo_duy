{"version":3,"sources":["../../../../../../assets/cc-common/cc-share-v1/common/assets/cc-common/cc-share-v1/common/PatchIOS14.js"],"names":["cc","Class","extends","Component","onLoad","_customEngineIOS","isIOS14Device","sys","os","OS_IOS","OS_OSX","isBrowser","test","window","navigator","userAgent","isOverride","flush","material","buffer","_buffer","indiceStart","indiceOffset","indiceCount","walking","effect","ia","_iaPool","add","_vertexBuffer","_vb","_indexBuffer","_ib","_start","_count","model","_modelPool","_batchedModels","push","sortKey","_sortKey","_cullingMask","cullingMask","setNode","node","setEffect","customProperties","setInputAssembler","_renderScene","addModel","uploadData","switchBuffer","byteStart","byteOffset","vertexStart","vertexOffset","MeshBuffer","prototype","checkAndSwitchBuffer","vertexCount","_batcher","__proto__","_flush"],"mappings":";;;;;;AAEAA,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;AAELC,UAFK,oBAEG;AACJ,aAAKC,gBAAL;AACH,KAJI;AAKLA,oBALK,8BAKa;AACd,YAAMC,gBAAgB,CAACN,GAAGO,GAAH,CAAOC,EAAP,KAAcR,GAAGO,GAAH,CAAOE,MAArB,IAA+BT,GAAGO,GAAH,CAAOC,EAAP,KAAcR,GAAGO,GAAH,CAAOG,MAArD,KAAgEV,GAAGO,GAAH,CAAOI,SAAvE,IAAoF,gCAAgCC,IAAhC,CAAqCC,OAAOC,SAAP,CAAiBC,SAAtD,CAA1G;AACA,YAAIT,aAAJ,EAAmB;AACf,gBAAIU,aAAa,KAAjB;AACA,gBAAIC,QAAQ,SAARA,KAAQ,GAAY;AACpB,oBAAIC,WAAW,KAAKA,QAApB;AAAA,oBACIC,SAAS,KAAKC,OADlB;AAAA,oBAEIC,cAAcF,OAAOE,WAFzB;AAAA,oBAGIC,eAAeH,OAAOG,YAH1B;AAAA,oBAIIC,cAAcD,eAAeD,WAJjC;AAKA,oBAAI,CAAC,KAAKG,OAAN,IAAiB,CAACN,QAAlB,IAA8BK,eAAe,CAAjD,EAAoD;AAChD;AACH;;AAED,oBAAIE,SAASP,SAASO,MAAtB;AACA,oBAAI,CAACA,MAAL,EAAa;;AAEb;AACA,oBAAIC,KAAK,KAAKC,OAAL,CAAaC,GAAb,EAAT;AACAF,mBAAGG,aAAH,GAAmBV,OAAOW,GAA1B;AACAJ,mBAAGK,YAAH,GAAkBZ,OAAOa,GAAzB;AACAN,mBAAGO,MAAH,GAAYZ,WAAZ;AACAK,mBAAGQ,MAAH,GAAYX,WAAZ;;AAEA;AACA,oBAAIY,QAAQ,KAAKC,UAAL,CAAgBR,GAAhB,EAAZ;AACA,qBAAKS,cAAL,CAAoBC,IAApB,CAAyBH,KAAzB;AACAA,sBAAMI,OAAN,GAAgB,KAAKC,QAAL,EAAhB;AACAL,sBAAMM,YAAN,GAAqB,KAAKC,WAA1B;AACAP,sBAAMQ,OAAN,CAAc,KAAKC,IAAnB;AACAT,sBAAMU,SAAN,CAAgBpB,MAAhB,EAAwB,KAAKqB,gBAA7B;AACAX,sBAAMY,iBAAN,CAAwBrB,EAAxB;;AAEA,qBAAKsB,YAAL,CAAkBC,QAAlB,CAA2Bd,KAA3B;;AAEA,oBAAI7B,aAAJ,EAAmB;AACfa,2BAAO+B,UAAP;AACA/B,2BAAOgC,YAAP;AACH,iBAHD,MAGO;AACHhC,2BAAOiC,SAAP,GAAmBjC,OAAOkC,UAA1B;AACAlC,2BAAOE,WAAP,GAAqBF,OAAOG,YAA5B;AACAH,2BAAOmC,WAAP,GAAqBnC,OAAOoC,YAA5B;AACH;AACJ,aAvCD;;AAyCAvD,eAAGwD,UAAH,CAAcC,SAAd,CAAwBC,oBAAxB,GAA+C,UAAUC,WAAV,EAAuB;AAClE,oBAAI,CAAC3C,UAAL,EAAiB;AACb;AACA,yBAAK4C,QAAL,CAAcC,SAAd,CAAwBC,MAAxB,GAAiC7C,KAAjC;AACAD,iCAAa,IAAb;AACH;AACD;AACA;;AAEA,oBAAI,KAAKuC,YAAL,GAAoBI,WAApB,GAAkC,KAAtC,EAA6C;AACzC,yBAAKT,UAAL;AACA,yBAAKU,QAAL,CAAcE,MAAd;AACH;AACJ,aAbD;AAcH;AACJ;AAjEI,CAAT","file":"PatchIOS14.js","sourceRoot":"../../../../../../assets/cc-common/cc-share-v1/common","sourcesContent":["\n\ncc.Class({\n    extends: cc.Component,\n    onLoad(){\n        this._customEngineIOS();\n    },\n    _customEngineIOS(){\n        const isIOS14Device = (cc.sys.os === cc.sys.OS_IOS || cc.sys.os === cc.sys.OS_OSX) && cc.sys.isBrowser && /(OS 1[4-9])|(Version\\/1[4-9])/.test(window.navigator.userAgent);\n        if (isIOS14Device) {\n            let isOverride = false;\n            let flush = function () {\n                let material = this.material,\n                    buffer = this._buffer,\n                    indiceStart = buffer.indiceStart,\n                    indiceOffset = buffer.indiceOffset,\n                    indiceCount = indiceOffset - indiceStart;\n                if (!this.walking || !material || indiceCount <= 0) {\n                    return;\n                }\n        \n                let effect = material.effect;\n                if (!effect) return;\n        \n                // Generate ia\n                let ia = this._iaPool.add();\n                ia._vertexBuffer = buffer._vb;\n                ia._indexBuffer = buffer._ib;\n                ia._start = indiceStart;\n                ia._count = indiceCount;\n        \n                // Generate model\n                let model = this._modelPool.add();\n                this._batchedModels.push(model);\n                model.sortKey = this._sortKey++;\n                model._cullingMask = this.cullingMask;\n                model.setNode(this.node);\n                model.setEffect(effect, this.customProperties);\n                model.setInputAssembler(ia);\n        \n                this._renderScene.addModel(model);\n        \n                if (isIOS14Device) {\n                    buffer.uploadData();\n                    buffer.switchBuffer();\n                } else {\n                    buffer.byteStart = buffer.byteOffset;\n                    buffer.indiceStart = buffer.indiceOffset;\n                    buffer.vertexStart = buffer.vertexOffset;\n                }\n            };\n        \n            cc.MeshBuffer.prototype.checkAndSwitchBuffer = function (vertexCount) {\n                if (!isOverride) {\n                    //method 1\n                    this._batcher.__proto__._flush = flush;\n                    isOverride = true;\n                }\n                //method 2\n                //this._batcher._flush = flush;\n        \n                if (this.vertexOffset + vertexCount > 65535) {\n                    this.uploadData();\n                    this._batcher._flush();\n                }\n            };\n        }\n    }\n});\n"]}